<!DOCTYPE html>
<html>
<head>
    <title>My Interactive Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    
    <!-- Leaflet Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <!-- Your custom CSS for styling the narrative map -->
    <style>
        /* Base styles for the entire page */
        body {
            padding: 0;
            margin: 0;
            font-family: 'Inter', sans-serif;
            color: #333;
            overflow-x: hidden;
            display: flex; /* Use flexbox for the main layout */
        }

        /* Sidebar container */
        #sidebar {
            width: 350px; /* Fixed width for the sidebar */
            height: 100vh;
            overflow-y: auto; /* Allows content to scroll within the sidebar */
            padding: 2rem;
            background-color: #f4f4f4;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
        }

        /* The main content area (map and narrative) */
        #content-area {
            flex-grow: 1; /* Takes up the remaining space */
            position: relative;
        }

        /* Map container */
        #map {
            width: 100%;
            height: 100vh;
            position: sticky;
            top: 0;
            z-index: 1;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Styling for the interactive map markers */
        .leaflet-marker-icon {
            animation: pulse 1.5s infinite ease-in-out;
        }

        /* Keyframe for the pulsing animation */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Form styling */
        .form-container {
            margin-top: 2rem;
            padding: 2rem;
            background-color: #f9f9f9;
            border-radius: 0.5rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
        }

        .add-marker-btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        
        .add-marker-btn:hover {
            background-color: #45a049;
        }

        /* Export button styling */
        .export-btn {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin-top: 1rem;
        }

        .export-btn:hover {
            background-color: #0056b3;
        }

        /* Info message box */
        #info-message {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f0f8ff;
            border: 1px solid #cce5ff;
            color: #004085;
            border-radius: 0.25rem;
            display: none;
            text-align: center;
        }

        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            body {
                flex-direction: column; /* Stack sidebar and content on small screens */
            }
            #sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
        }
    </style>
</head>
<body>

    <!-- Main container for the layout -->
    <div id="sidebar">
        <h1>My Interactive Map</h1>
        <p>Instructions: Use the search box or click on the map to select a location. Once a location is selected, fill out the form to add a new point of interest with your details.</p>

        <div id="info-message"></div>

        <!-- Search input container for a cleaner layout -->
        <div class="search-container">
            <b>Enter location information here. You can search by a place name, address, or any type of location data.</b>
            <div id="search-bar"></div>
        </div>
        
        <!-- Marker Creation Form -->
        <h2>Create a New Point of Interest</h2>
        <form id="markerForm" class="form-container">
            <div class="form-group">
                <label for="userName">Your Name:</label>
                <input type="text" id="userName" required>
            </div>
            <div class="form-group">
                <label for="markerName">Marker Name:</label>
                <input type="text" id="markerName" required>
            </div>
            <div class="form-group">
                <label for="markerText">Description:</label>
                <textarea id="markerText" rows="4" required></textarea>
            </div>
            <div class="form-group">
                <label for="mediaUrl">Image/Video URL:</label>
                <input type="text" id="mediaUrl">
            </div>
            <button type="submit" class="add-marker-btn">Add Marker</button>
        </form>
        
        <button id="exportBtn" class="export-btn">Export Data to Spreadsheet</button>
    </div>

    <div id="content-area">
        <!-- The map container. Leaflet will render the map inside this div. -->
        <div id="map"></div>
    </div>

    <!-- Firebase JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Store the last clicked location
        let lastClickedLatLng = null;
        let temporaryMarker = null;

        // Firebase Initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        let db, auth;

        // Map and markers
        let map;
        const markersLayer = L.layerGroup();
        const redCircleIcon = new L.Icon({
            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMjUiIGZpbGw9InJlZCIvPjwvc3ZnPg==',
            iconSize: [64, 64],
            iconAnchor: [32, 32],
            popupAnchor: [0, -25]
        });

        window.onload = async function() {
            // Initialize the map and set its view
            map = L.map('map').setView([39.8283, -98.5795], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            // Add the search control to the map
            const geocoder = L.Control.geocoder().addTo(map);

            // Event listener for geocoder results
            geocoder.on('markgeocode', function(e) {
                const latlng = e.geocode.center;
                map.setView(latlng, 12);
                showMessage("Location found! Now click on the map to place a marker and fill out the form.", true);
            });

            // Add event listener to the map to capture a click location
            map.on('click', function(e) {
                lastClickedLatLng = e.latlng;
                if (temporaryMarker) { map.removeLayer(temporaryMarker); }
                temporaryMarker = L.marker(e.latlng, { icon: redCircleIcon }).addTo(map);
                temporaryMarker.bindPopup("This is your selected location.<br>Fill out the form to add details.").openPopup();
                showMessage("Location selected! Now fill out the form.", true);
            });
            
            // Initialize Firebase and related features in a separate block
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Use the custom auth token if available, otherwise sign in anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                markersLayer.addTo(map);
                setupRealtimeMarkers();
                setupFormListener();
                setupExportButton();

            } catch (error) {
                console.error("Firebase initialization error: ", error);
                showMessage("Firebase failed to load. Marker data will not be saved.", false);
            }
        };

        // Set up real-time listener for markers
        function setupRealtimeMarkers() {
            if (!db) return;
            const markersRef = collection(db, `/artifacts/${appId}/public/data/markers`);
            onSnapshot(markersRef, (snapshot) => {
                markersLayer.clearLayers();
                snapshot.forEach((doc) => {
                    const markerData = doc.data();
                    const marker = L.marker([markerData.lat, markerData.lng], { icon: redCircleIcon }).addTo(markersLayer);
                    const popupContent = `
                        <div style="font-family: 'Inter', sans-serif; text-align: center;">
                            <h3 style="margin-top:0; color:#333; font-weight:bold;">${markerData.name}</h3>
                            <p style="font-size:0.9em; line-height:1.4; color:#555;">${markerData.text}</p>
                            ${markerData.mediaHtml}
                            <p style="font-size:0.8em; margin-top:1rem; color:#888;">Added by: <b>${markerData.userName}</b></p>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                });
            });
        }

        // Handle the form logic for adding new markers
        function setupFormListener() {
            const markerForm = document.getElementById("markerForm");
            markerForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                if (!db) {
                    showMessage("Database not available. Cannot save marker.", false);
                    return;
                }

                if (!lastClickedLatLng) {
                    showMessage("Please select a location on the map first!", false);
                    return;
                }

                const userName = document.getElementById('userName').value;
                const markerName = document.getElementById('markerName').value;
                const markerText = document.getElementById('markerText').value;
                const mediaUrl = document.getElementById('mediaUrl').value;
                let mediaHtml = '';

                // Check if the URL is for an image or a video
                if (mediaUrl) {
                    if (mediaUrl.match(/\.(jpeg|jpg|gif|png)$/i)) {
                        mediaHtml = `<img src="${mediaUrl}" style="max-width:100%; height:auto; border-radius:8px;" onerror="this.src='https://placehold.co/150x100?text=Invalid+Image'">`;
                    } else if (mediaUrl.match(/\.(mp4|webm|ogg)$/i)) {
                        mediaHtml = `<video controls style="max-width:100%; height:auto; border-radius:8px;"><source src="${mediaUrl}"></video>`;
                    } else {
                        mediaHtml = `<p>Invalid media URL. Please use a direct link to a supported image or video file.</p>`;
                    }
                }

                const markerData = {
                    userName: userName,
                    name: markerName,
                    text: markerText,
                    lat: lastClickedLatLng.lat,
                    lng: lastClickedLatLng.lng,
                    mediaUrl: mediaUrl,
                    mediaHtml: mediaHtml,
                    timestamp: new Date()
                };

                try {
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/markers`), markerData);
                    showMessage("Marker details added successfully!", true);
                    markerForm.reset();
                    lastClickedLatLng = null; // Reset for the next marker
                    if (temporaryMarker) { map.removeLayer(temporaryMarker); temporaryMarker = null; }
                } catch (error) {
                    console.error("Error adding document: ", error);
                    showMessage("Failed to save marker. Please try again.", false);
                }
            });
        }

        function setupExportButton() {
            const exportBtn = document.getElementById("exportBtn");
            exportBtn.addEventListener('click', async function() {
                if (!db) {
                    showMessage("Database not available. Cannot export data.", false);
                    return;
                }
                
                try {
                    const markersRef = collection(db, `/artifacts/${appId}/public/data/markers`);
                    const querySnapshot = await getDocs(query(markersRef));
                    const markers = [];
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        markers.push({
                            id: doc.id,
                            userName: data.userName,
                            name: data.name,
                            description: data.text,
                            latitude: data.lat,
                            longitude: data.lng,
                            mediaUrl: data.mediaUrl,
                            timestamp: data.timestamp.toDate().toISOString()
                        });
                    });

                    if (markers.length === 0) {
                        showMessage("No markers to export.", false);
                        return;
                    }

                    // Convert markers to CSV format
                    const headers = ["id", "userName", "name", "description", "latitude", "longitude", "mediaUrl", "timestamp"];
                    const csvContent = "data:text/csv;charset=utf-8," 
                        + headers.join(",") + "\n"
                        + markers.map(e => headers.map(header => JSON.stringify(e[header])).join(",")).join("\n");
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "map_data.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showMessage("Data exported successfully to map_data.csv!", true);

                } catch (error) {
                    console.error("Error exporting data: ", error);
                    showMessage("Failed to export data. Please try again.", false);
                }
            });
        }
        
        // Function to display a message to the user
        function showMessage(message, isSuccess = false) {
            const infoBox = document.getElementById("info-message");
            infoBox.textContent = message;
            infoBox.style.display = "block";
            infoBox.style.backgroundColor = isSuccess ? '#d4edda' : '#f8d7da';
            infoBox.style.borderColor = isSuccess ? '#c3e6cb' : '#f5c6cb';
            infoBox.style.color = isSuccess ? '#155724' : '#721c24';
        }

    </script>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    
    <!-- Leaflet Geocoder JS -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

</body>
</html>

